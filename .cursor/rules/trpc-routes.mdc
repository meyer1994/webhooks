---
globs: server/trpc/**/*.ts
alwaysApply: false
---

# tRPC Route Patterns

Guidelines for creating tRPC routers and procedures.

## File Structure

```
server/trpc/
├── index.ts     # Main app router (merges all other routers)
└── [route].ts   # Domain-specific routers (e.g., users.ts, files.ts)
```

## Basic Route Template

```typescript
import { z } from "zod";
import { TUsers } from "../db/schema";
import { baseProcedure, createTRPCRouter } from "../utils/trpc";

export const userRouter = createTRPCRouter({
  list: baseProcedure
    .input(z.object({ limit: z.number().optional() }))
    .query(async ({ input, ctx }) => {
      // Use ctx.db for database access
      return await ctx.db
        .select()
        .from(TUsers)
        .limit(input.limit ?? 10);
    }),

  create: baseProcedure
    .input(z.object({ name: z.string() }))
    .mutation(async ({ input, ctx }) => {
      const [result] = await ctx.db
        .insert(TUsers)
        .values({ name: input.name })
        .returning();
      return result;
    }),
});
```

## Procedures & Context

All procedures have access to the context `ctx`, which includes:

- `ctx.db`: Drizzle database instance.
- `ctx.storage`: File storage utility.
- `ctx.vector`: Vector storage utility.
- `ctx.event`: The H3 event.

## Key Guidelines

1. **Input Validation**: Always use Zod for `.input()`.
2. **Error Handling**: Do not use `try/catch` inside procedures unless you need to transform an error. Let tRPC handle errors automatically.
3. **Simplicity**: Procedures should be thin. Move complex logic to `server/utils/` if it needs to be reused.
4. **Naming**: Use descriptive names for procedures (`list`, `get`, `create`, `update`, `delete`).
